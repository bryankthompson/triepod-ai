name: Deploy to Fileserver

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
        
    - name: Add fileserver to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.FILESERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to fileserver
      run: |
        # Create deployment directory if it doesn't exist
        ssh ${{ secrets.FILESERVER_USER }}@${{ secrets.FILESERVER_HOST }} "mkdir -p /var/www/triepod.ai"
        
        # Sync build output to fileserver
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.env*' \
          ./ ${{ secrets.FILESERVER_USER }}@${{ secrets.FILESERVER_HOST }}:/var/www/triepod.ai/
          
        # Install dependencies on fileserver
        ssh ${{ secrets.FILESERVER_USER }}@${{ secrets.FILESERVER_HOST }} "cd /var/www/triepod.ai && npm ci --production"
        
        # Restart application (if using PM2 or similar)
        ssh ${{ secrets.FILESERVER_USER }}@${{ secrets.FILESERVER_HOST }} "cd /var/www/triepod.ai && pm2 restart triepod-ai || pm2 start npm --name triepod-ai -- start"
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ Deployment successful to https://triepod.ai"
        else
          echo "❌ Deployment failed"
        fi